<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>私人聊天</title>
    <!-- 引用正確的 CDN 連結 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
    <!-- 會話列表 -->
    <div id="sessionList"></div>

    <!-- 聊天視圖 -->
    <div id="chat">
        <div id="messageArea"></div>
        <input type="text" id="messageInput" placeholder="輸入訊息..." />
        <button onclick="sendMessage()">發送</button>
    </div>

    <script>
        var stompClient = null;
        var currentChatId = null;
        var senderId = localStorage.getItem('user_id'); // 當前使用者 ID，實際應從後端獲取
        var receiverId = '2'; // 目前聊天對象的 ID

        // 從 localStorage 獲取 access_token，這是在登入後保存的
        var accessToken = localStorage.getItem('access_token');

        // 連線到 WebSocket
        function connect() {
            // 將 token 作為查詢參數附加到 SockJS URL 中
            var socket = new SockJS('/ws?token=' + accessToken);
            stompClient = Stomp.over(socket);

            // 不再需要在 headers 中傳遞 Authorization
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                // 訂閱個人訊息
                stompClient.subscribe('/user/queue/messages', function(message) {
                    showMessage(JSON.parse(message.body));
                });
                if (typeof onConnected === "function") {
                    onConnected();  // 確保 onConnected 已定義
                }
            }, function(error) {
                if (!alertDisplayed) {
                    alertDisplayed = true;  
                    console.error('Could not connect to WebSocket server:', error);

                    localStorage.removeItem('accessToken');
                    alert('請重新登錄。');
                    window.location.href = '/signin.html';
                }
            });
        }


        // 獲取會話列表
        function loadSessions() {
            axios.get('/api/1.0/chat/sessions', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(response) {
                var sessions = response.data.data;
                var sessionList = document.getElementById('sessionList');
                sessionList.innerHTML = '';
                sessions.forEach(function(session) {
                    var participantId = session.participants.find(id => id != senderId);
                    var sessionElement = document.createElement('div');
                    sessionElement.innerHTML = '與用戶 ' + participantId + ' 的對話:' + session.latestMessage.content;
                    sessionElement.onclick = function() {
                        openChat(session.chatId, participantId);
                    };
                    sessionList.appendChild(sessionElement);
                });
            })
            .catch(function(error) {
                console.error('Error loading sessions:', error);
            });
        }

        // 打開聊天
        function openChat(chatId, participantId) {
            currentChatId = chatId;
            receiverId = participantId;
            document.getElementById('messageArea').innerHTML = '';

            // 獲取聊天歷史
            axios.get('/api/1.0/chat/history', {
                params: {
                    chatId: chatId,
                    page: 0,
                    size: 20
                },
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(response) {
                var messages = response.data.data;
                messages.reverse(); // 因為是按時間降序排序
                messages.forEach(showMessage);
            })
            .catch(function(error) {
                console.error('Error loading chat history:', error);
            });
        }

        // 發送訊息
        function sendMessage() {
            var content = document.getElementById('messageInput').value;
            if(content && stompClient && receiverId) {
                // 確保 chatId 中較小的 ID 在前
                var chatId = senderId < receiverId ? (senderId + '_' + receiverId) : (receiverId + '_' + senderId);
                
                var message = {
                    chatId: currentChatId || chatId,
                    senderId: senderId,
                    receiverId: receiverId,
                    content: content
                };
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
                document.getElementById('messageInput').value = '';
                showMessage(message);
            }
        }

        // 顯示訊息
        function showMessage(message) {
            var messageArea = document.getElementById('messageArea');
            var messageElement = document.createElement('div');
            messageElement.innerHTML = '<b>' + (message.senderId === senderId ? '你' : '用戶 ' + message.senderId) + ':</b> ' + message.content;
            messageArea.appendChild(messageElement);
        }

        // 初始化
        connect();
        loadSessions();
    </script>
</body>
</html>
