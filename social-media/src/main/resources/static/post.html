<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title >Goglobal 社群平台</title>
    <link href="/css/post.css" rel="stylesheet">
</head>
<body>

<header>
    <div class="brand">
        <h1>Goglobal</h1>
    </div>
    <button class="saved-button" onclick="toggleSavedPostsModal()">
        <img src="./img/saved.png" alt="我的收藏">
    </button>
</header>

<main>
    <!-- 創建貼文表單 -->
    <div class="post-form">
        <h2>創建新貼文</h2>
        <textarea id="postContent" placeholder="分享你的想法..."></textarea>
        <label for="postImages" class="image-upload">
            <span>拖曳或點擊此處上傳圖片</span>
            <input type="file" id="postImages" accept="image/*" multiple onchange="previewImages('postImages', 'postImagePreview')">
            <div class="image-preview" id="postImagePreview" onclick="event.stopPropagation()"></div>
        </label>        
        <div class="tag-selection" id="tagSelection">
            <!-- 標籤按鈕將在此處生成 -->
        </div>
        <button class="btn-primary" onclick="createPost()">發佈</button>
    </div>

    <!-- 加載指示器 -->
    <div id="loadingSpinner" class="spinner" style="display: none;"></div>

    <!-- 貼文列表 -->
    <div id="postList"></div>
</main>

<!-- 編輯貼文模態框 -->
<div id="editPostModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="toggleEditPostModal(false)">&times;</button>
        <h2>編輯貼文</h2>
        <textarea id="editPostContent" placeholder="編輯你的想法..."></textarea>
        <label for="editPostImages" class="image-upload">
            <span>拖曳或點擊此處上傳圖片</span>
            <input type="file" id="editPostImages" accept="image/*" multiple onchange="previewImages('editPostImages', 'editPostImagePreview')">
            <div class="image-preview" id="editPostImagePreview" onclick="event.stopPropagation()"></div>
        </label>        
        <div class="tag-selection" id="editTagSelection">
            <!-- 標籤按鈕將在此處生成 -->
        </div>
        <button class="btn-primary" onclick="saveEditedPost()">保存更改</button>
    </div>
</div>

<!-- 收藏的貼文模態框 -->
<div id="savedPostsModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="toggleSavedPostsModal()">&times;</button>
        <h2>我的收藏</h2>
        <div id="savedPosts"></div>
    </div>
</div>

<!-- JavaScript 代碼 -->
<script>
    const apiBaseUrl = 'http://43.206.30.58:8080/api/1.0/posts';

    // 從 localStorage 獲取 accessToken 和 userId
    const accessToken = localStorage.getItem('accessToken');
    const userId = localStorage.getItem('userId');

    // 設置請求頭
    const headers = {
        'Authorization': 'Bearer ' + accessToken
    };

    // 標籤列表
    const tagsList = [
        '語言檢定', '語言學習', '簽證', '旅遊', '交換申請',
        '留學申請', '獎學金', '行前準備', '住宿', '交通',
        '學校活動', '學校課程', '學校社團', '交換日誌', '交換心得', '其他'
    ];

    let selectedTags = [];
    let editSelectedTags = [];
    let currentEditPostId = null;
    let savedPostIds = []; // 用於存儲已收藏的 postId

    // 初始化標籤選擇
    function initTagSelection() {
        const tagSelectionDiv = document.getElementById('tagSelection');
        tagsList.forEach(tag => {
            const tagButton = document.createElement('button');
            tagButton.textContent = tag;
            tagButton.onclick = () => toggleTag(tagButton, tag, 'create');
            tagSelectionDiv.appendChild(tagButton);
        });
    }

    // 初始化編輯標籤選擇
    function initEditTagSelection() {
        const tagSelectionDiv = document.getElementById('editTagSelection');
        tagsList.forEach(tag => {
            const tagButton = document.createElement('button');
            tagButton.textContent = tag;
            tagButton.onclick = () => toggleTag(tagButton, tag, 'edit');
            tagSelectionDiv.appendChild(tagButton);
        });
    }

    // 標籤選擇/取消
    function toggleTag(button, tag, mode) {
        if (mode === 'create') {
            if (selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
                button.classList.remove('selected');
            } else {
                if (selectedTags.length >= 3) {
                    alert('最多只能選擇 3 個標籤');
                    return;
                }
                selectedTags.push(tag);
                button.classList.add('selected');
            }
        } else if (mode === 'edit') {
            if (editSelectedTags.includes(tag)) {
                editSelectedTags = editSelectedTags.filter(t => t !== tag);
                button.classList.remove('selected');
            } else {
                if (editSelectedTags.length >= 3) {
                    alert('最多只能選擇 3 個標籤');
                    return;
                }
                editSelectedTags.push(tag);
                button.classList.add('selected');
            }
        }
    }

    // 預覽上傳圖片
    function previewImages(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        preview.innerHTML = '';
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }

    // 創建新貼文
    function createPost() {
        const content = document.getElementById('postContent').value;
        const imagesInput = document.getElementById('postImages');
        const images = imagesInput.files;

        if (!content.trim()) {
            alert('貼文內容不可為空');
            return;
        }

        const formData = new FormData();
        formData.append('content', content);
        selectedTags.forEach(tag => formData.append('tags', tag));
        Array.from(images).forEach(image => formData.append('imageFiles', image)); // 修改鍵名

        showLoading();

        fetch(apiBaseUrl, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            },
            body: formData
        })
        .then(response => {
            hideLoading();
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('貼文創建成功！');
            document.getElementById('postContent').value = '';
            selectedTags = [];
            document.querySelectorAll('.tag-selection button').forEach(btn => btn.classList.remove('selected'));
            imagesInput.value = '';
            document.getElementById('postImagePreview').innerHTML = '';
            loadPosts();
        })
        .catch(error => {
            hideLoading();
            console.error('後端錯誤:', error.message);
        });
    }

// 現有代碼...

// 加載貼文列表
function loadPosts() {
    showLoading();
    fetch(`${apiBaseUrl}/recommended`, {
        headers: headers
    })
    .then(response => {
        hideLoading();
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.error);
            });
        }
        return response.json();
    })
    .then(data => {
        // 顯示「創建新貼文」區塊
        document.querySelector('.post-form').style.display = 'block';

        const postList = document.getElementById('postList');
        postList.innerHTML = '';
        if (!data.content || data.content.length === 0) {
            postList.innerHTML = '<p>目前沒有任何貼文。</p>';
            return;
        }
        data.content.forEach(post => {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            postElement.onclick = () => viewPost(post.postId);
            postElement.innerHTML = `
                <div class="post-header">
                    <img src="${post.images && post.images.length > 0 ? post.images[0] : 'https://i.pravatar.cc/50?u=' + post.userId}" alt="Avatar">
                    <div class="author-info">
                        <h3>${post.name}</h3>
                        <p>${new Date(post.createdAt).toLocaleString()}</p>
                    </div>
                </div>
                <div class="post-content">${post.content}</div>
                <div class="post-tags">
                    ${post.tags.map(tag => `<span>${tag}</span>`).join('')}
                </div>
                ${post.images && post.images.length > 0 ? `
                    <div class="post-images">
                        ${post.images.map(img => `<img src="${img}" alt="Post Image">`).join('')}
                    </div>
                ` : ''}
                <div class="post-actions" onclick="event.stopPropagation()">
                    <button onclick="${isPostSaved(post.postId) ? `unsavePost('${post.postId}')` : `savePost('${post.postId}')`}">
                        <img src="${isPostSaved(post.postId) ? './img/saved.png' : './img/unSaved.png'}" alt="${isPostSaved(post.postId) ? '取消收藏' : '收藏'}">
                    </button>
                    ${post.userId == userId ? `
                    <button onclick="editPost('${post.postId}')">
                        <img src="./img/edit.png" alt="編輯">
                    </button>
                    <button onclick="deletePost('${post.postId}')">
                        <img src="./img/delete.png" alt="刪除">
                    </button>
                    ` : ''}
                </div>
            `;
            postList.appendChild(postElement);
        });
    })
    .catch(error => {
        hideLoading();
        console.error('後端錯誤:', error.message);
    });
}

// 查看貼文詳情
function viewPost(postId) {
    showLoading();
    fetch(`${apiBaseUrl}/${postId}`, {
        headers: headers
    })
    .then(response => {
        hideLoading();
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.error);
            });
        }
        return response.json();
    })
    .then(data => {
        // 隱藏「創建新貼文」區塊
        document.querySelector('.post-form').style.display = 'none';

        const post = data.data;
        const postList = document.getElementById('postList');
        postList.innerHTML = ''; // 清空列表
        const postDetail = document.createElement('div');
        postDetail.className = 'post';
        postDetail.innerHTML = `
            <div class="post-header">
                <img src="${post.images && post.images.length > 0 ? post.images[0] : 'https://i.pravatar.cc/50?u=' + post.userId}" alt="Avatar">
                <div class="author-info">
                    <h3>${post.name}</h3>
                    <p>${new Date(post.createdAt).toLocaleString()}</p>
                </div>
            </div>
            <div class="post-content">${post.content}</div>
            <div class="post-tags">
                ${post.tags.map(tag => `<span>${tag}</span>`).join('')}
            </div>
            ${post.images && post.images.length > 0 ? `
                <div class="post-images">
                    ${post.images.map(img => `<img src="${img}" alt="Post Image">`).join('')}
                </div>
            ` : ''}
            <div class="post-actions" onclick="event.stopPropagation()">
                <button onclick="${isPostSaved(post.postId) ? `unsavePost('${post.postId}')` : `savePost('${post.postId}')`}">
                    <img src="${isPostSaved(post.postId) ? './img/saved.png' : './img/unSaved.png'}" alt="${isPostSaved(post.postId) ? '取消收藏' : '收藏'}">
                </button>
                ${post.userId == userId ? `
                <button onclick="editPost('${post.postId}')">
                    <img src="./img/edit.png" alt="編輯">
                </button>
                <button onclick="deletePost('${post.postId}')">
                    <img src="./img/delete.png" alt="刪除">
                </button>
                ` : ''}
            </div>
            <div class="comments-section">
                <h4>評論：</h4>
                <div id="comments">
                    ${post.comments && post.comments.length > 0 ? post.comments.map(comment => `
                        <div class="comment">
                            <p><strong>${comment.name}</strong>：${comment.content}</p>
                            ${comment.userId == userId ? `
                                <div class="comment-actions">
                                    <button onclick="deleteComment('${postId}', '${comment.commentId}')">刪除評論</button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') : '<p>暫無評論，快來成為第一個評論者吧！</p>'}
                </div>
                <div class="comment-form">
                    <textarea id="commentContent" placeholder="添加評論..."></textarea>
                    <button class="btn-primary" onclick="addComment('${postId}')">評論</button>
                </div>
                <!-- 添加返回按鈕 -->
                <button class="btn-primary" onclick="loadPosts()" style="margin-top: 15px;">返回貼文列表</button>
            </div>
        `;
        postList.appendChild(postDetail);
    })
    .catch(error => {
        hideLoading();
        console.error('後端錯誤:', error.message);
    });
}

// 現有代碼...

    // 加載已收藏的貼文 ID
    function loadSavedPostIds() {
        fetch(`${apiBaseUrl}/saved`, {
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            savedPostIds = data.data.map(post => post.postId);
            // 獲取收藏列表後再加載貼文列表
            loadPosts();
        })
        .catch(error => {
            console.error('獲取收藏列表時出錯:', error.message);
            // 即使出錯也繼續加載貼文列表
            loadPosts();
        });
    }

    // 判斷貼文是否已收藏
    function isPostSaved(postId) {
        return savedPostIds.includes(postId);
    }


    // 添加評論
    function addComment(postId) {
        const content = document.getElementById('commentContent').value;

        if (!content.trim()) {
            alert('評論內容不可為空');
            return;
        }

        fetch(`${apiBaseUrl}/${postId}/comment`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('評論添加成功！');
            viewPost(postId);
        })
        .catch(error => {
            console.error('後端錯誤:', error.message);
        });
    }

    // 刪除評論
    function deleteComment(postId, commentId) {
        if (!confirm('確定要刪除這條評論嗎？')) return;

        fetch(`${apiBaseUrl}/${postId}/comment/${commentId}`, {
            method: 'DELETE',
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('評論已刪除！');
            viewPost(postId);
        })
        .catch(error => {
            console.error('後端錯誤:', error.message);
        });
    }

    // 編輯貼文
    function editPost(postId) {
        currentEditPostId = postId;
        showLoading();
        fetch(`${apiBaseUrl}/${postId}`, {
            headers: headers
        })
        .then(response => {
            hideLoading();
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            const post = data.data;
            document.getElementById('editPostContent').value = post.content;
            editSelectedTags = [...post.tags];
            document.querySelectorAll('#editTagSelection button').forEach(btn => {
                if (editSelectedTags.includes(btn.textContent)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            // 顯示已上傳的圖片
            if (post.images && post.images.length > 0) {
                const preview = document.getElementById('editPostImagePreview');
                preview.innerHTML = '';
                post.images.forEach(imgUrl => {
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    preview.appendChild(img);
                });
            }
            toggleEditPostModal(true);
        })
        .catch(error => {
            hideLoading();
            console.error('後端錯誤:', error.message);
        });
    }

    // 保存編輯後的貼文
    function saveEditedPost() {
        const content = document.getElementById('editPostContent').value;
        const imagesInput = document.getElementById('editPostImages');
        const images = imagesInput.files;

        if (!content.trim()) {
            alert('貼文內容不可為空');
            return;
        }

        const formData = new FormData();
        formData.append('content', content);
        editSelectedTags.forEach(tag => formData.append('tags', tag));
        Array.from(images).forEach(image => formData.append('imageFiles', image)); // 修改鍵名

        showLoading();

        fetch(`${apiBaseUrl}/${currentEditPostId}`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            },
            body: formData
        })
        .then(response => {
            hideLoading();
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('貼文已更新！');
            toggleEditPostModal(false);
            loadPosts();
        })
        .catch(error => {
            hideLoading();
            console.error('後端錯誤:', error.message);
        });
    }

    // 刪除貼文
    function deletePost(postId) {
        if (!confirm('確定要刪除這個貼文嗎？')) return;

        fetch(`${apiBaseUrl}/${postId}`, {
            method: 'DELETE',
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('貼文已刪除！');
            loadPosts();
        })
        .catch(error => {
            console.error('後端錯誤:', error.message);
        });
    }

    // 收藏貼文
    function savePost(postId) {
        fetch(`${apiBaseUrl}/${postId}/save`, {
            method: 'POST',
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('貼文已收藏！');
            // 更新收藏的貼文 ID 列表
            savedPostIds.push(postId);
            loadPosts();
        })
        .catch(error => {
            console.error('後端錯誤:', error.message);
        });
    }

    // 取消收藏貼文
    function unsavePost(postId) {
        fetch(`${apiBaseUrl}/${postId}/save`, {
            method: 'DELETE',
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            alert('已取消收藏！');
            // 從收藏的貼文 ID 列表中移除
            savedPostIds = savedPostIds.filter(id => id !== postId);
            loadPosts();
        })
        .catch(error => {
            console.error('後端錯誤:', error.message);
        });
    }

    // 加載收藏的貼文
    function loadSavedPosts() {
        showLoading();
        fetch(`${apiBaseUrl}/saved`, {
            headers: headers
        })
        .then(response => {
            hideLoading();
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error);
                });
            }
            return response.json();
        })
        .then(data => {
            const savedPosts = document.getElementById('savedPosts');
            savedPosts.innerHTML = '';
            if (!data.data || data.data.length === 0) {
                savedPosts.innerHTML = '<p class="no-saved-posts">你還沒有收藏的貼文，快去收藏吧！</p>';
                return;
            }
            data.data.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post';
                postElement.onclick = () => viewPost(post.postId);
                postElement.innerHTML = `
                    <div class="post-header">
                        <img src="${post.images && post.images.length > 0 ? post.images[0] : 'https://i.pravatar.cc/50?u=' + post.userId}" alt="Avatar">
                        <div class="author-info">
                            <h3>${post.name}</h3>
                            <p>${new Date(post.createdAt).toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    <div class="post-tags">
                        ${post.tags.map(tag => `<span>${tag}</span>`).join('')}
                    </div>
                    ${post.images && post.images.length > 0 ? `
                        <div class="post-images">
                            ${post.images.map(img => `<img src="${img}" alt="Post Image">`).join('')}
                        </div>
                    ` : ''}
                    <div class="post-actions" onclick="event.stopPropagation()">
                        <button onclick="unsavePost('${post.postId}')">
                            <img src="./img/saved.png" alt="取消收藏">
                        </button>
                    </div>
                `;
                savedPosts.appendChild(postElement);
            });
        })
        .catch(error => {
            hideLoading();
            console.error('後端錯誤:', error.message);
        });
    }

    // 切換收藏貼文模態框
    function toggleSavedPostsModal() {
        const modal = document.getElementById('savedPostsModal');
        if (modal.style.display === 'block') {
            modal.style.display = 'none';
        } else {
            loadSavedPosts();
            modal.style.display = 'block';
        }
    }

    // 切換編輯貼文模態框
    function toggleEditPostModal(show = true) {
        const modal = document.getElementById('editPostModal');
        if (show) {
            modal.style.display = 'block';
        } else {
            modal.style.display = 'none';
            document.getElementById('editPostContent').value = '';
            editSelectedTags = [];
            document.querySelectorAll('#editTagSelection button').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('editPostImages').value = '';
            document.getElementById('editPostImagePreview').innerHTML = '';
        }
    }

    // 初始化加載
    window.onload = function() {
        initTagSelection();
        initEditTagSelection();
        loadSavedPostIds(); // 加載收藏的貼文 ID
    }

    // 加載和隱藏加載指示器
    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    // 點擊外部區域關閉模態框
    window.onclick = function(event) {
        const editModal = document.getElementById('editPostModal');
        const savedModal = document.getElementById('savedPostsModal');
        if (event.target == editModal) {
            toggleEditPostModal(false);
        }
        if (event.target == savedModal) {
            toggleSavedPostsModal();
        }
    }
</script>

</body>
</html>
